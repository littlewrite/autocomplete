#!/usr/bin/env node

/**
 * 将 src/git.ts 转为 dart/lib/specs/git.dart
 *
 * 策略：
 * - 能自动转换的部分（静态 spec 结构、gitGenerators.xxx 引用）转为 Dart
 * - 无法转换的部分（函数、generateSpec、parserDirectives、整块 gitGenerators 等）
 *   原样保留为 TypeScript 注释，用 // TS_UNCONVERTED_START ... // TS_UNCONVERTED_END 包裹，
 *   便于后续 grep 或 AI 专注处理这些块
 *
 * 使用：node tools/convert-git-to-dart.cjs
 */

const fs = require("fs");
const path = require("path");
const { convertTsToDart, TsToDartConverter } = require("./converter-engine.cjs");

const SRC_GIT = path.resolve(__dirname, "../src/git.ts");
const OUT_GIT = path.resolve(__dirname, "../dart/lib/specs/git.dart");

/**
 * 用括号平衡从 code 中提取 export const gitGenerators ... = { ... }; 的整段源码
 */
function extractGitGeneratorsBlock(code) {
  const re = /export\s+const\s+gitGenerators\s*:\s*Record[^=]*=\s*\{/;
  const match = code.match(re);
  if (!match) return null;
  let i = code.indexOf("{", match.index);
  if (i === -1) return null;
  let depth = 0;
  let inString = false;
  let stringChar = "";
  const startIdx = match.index;
  for (; i < code.length; i++) {
    const c = code[i];
    const prev = i > 0 ? code[i - 1] : "";
    if (!inString) {
      if ((c === '"' || c === "'" || c === "`") && prev !== "\\") {
        inString = true;
        stringChar = c;
      } else if (c === "{") depth++;
      else if (c === "}") {
        depth--;
        if (depth === 0) {
          // 找到闭合 }; 可能带分号
          let end = i + 1;
          if (code[end] === ";") end++;
          return code.slice(startIdx, end);
        }
      }
    } else if (c === stringChar && prev !== "\\") inString = false;
  }
  return null;
}

/**
 * 将一段 TS 源码转为 Dart 文件中的多行注释（每行 // 前缀）
 */
function asDartLineComments(tsBlock) {
  return tsBlock
    .replace(/\*\//g, "* /")
    .split("\n")
    .map((line) => "// " + line)
    .join("\n");
}

function main() {
  const tsCode = fs.readFileSync(SRC_GIT, "utf8");

  // 1) 提取 gitGenerators 整块，用于放在文件顶部注释
  const gitGeneratorsBlock = extractGitGeneratorsBlock(tsCode);
  if (!gitGeneratorsBlock) {
    console.error("Could not extract gitGenerators block from git.ts");
    process.exit(1);
  }

  // 2) 用 commentFallback 模式跑转换引擎，得到 spec 的 Dart
  let dartSpecPart;
  try {
    dartSpecPart = convertTsToDart(SRC_GIT, tsCode, { commentFallback: true });
  } catch (e) {
    console.error("Conversion failed:", e.message);
    process.exit(1);
  }

  // 3) 在生成的 Dart 中，只保留 /// Completion spec ... 与 final FigSpec ... 到结尾
  const specMatch = dartSpecPart.match(/(\/\/\/\s+Completion spec[\s\S]+?final\s+FigSpec\s+\w+\s*=\s*FigSpec[\s\S]+?;\s*)\n?$/);
  const specOnly = specMatch ? specMatch[1] : dartSpecPart;

  // 4) 组装最终 git.dart
  const header = `// Auto-generated from TypeScript source: git.ts
// Generated by tools/convert-git-to-dart.cjs
// Parts that could not be auto-converted are kept as comments with marker:
//   // TS_UNCONVERTED_START (label) ... // TS_UNCONVERTED_END
// Use: grep -n "TS_UNCONVERTED" to find blocks for manual or AI-assisted conversion.
// gitGenerators implemented in lib/src/git_generators.dart

`;

  const imports = `import 'package:autocomplete/src/git_generators.dart' show gitGenerators;
import 'package:autocomplete/src/spec.dart';

`;

  const gitGeneratorsComment = `// TS_UNCONVERTED_START gitGenerators (reference only; implementation in git_generators.dart)
${asDartLineComments(gitGeneratorsBlock)}
// TS_UNCONVERTED_END

`;

  const out = header + imports + gitGeneratorsComment + specOnly;

  fs.mkdirSync(path.dirname(OUT_GIT), { recursive: true });
  fs.writeFileSync(OUT_GIT, out, "utf8");
  console.log("Wrote", OUT_GIT);
  console.log("Search for 'TS_UNCONVERTED' to find blocks that need manual conversion.");
}

main();
